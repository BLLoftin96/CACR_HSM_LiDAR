---
title: "CACR LiDAR Habitat Suitability Modeling"
author: "Willow L. Loftin"
date: "2026-01-02"
output: html_document
---

# GitHub Setup

I am using GitHub as a form of version control, so I will need to connect this document to the repository on GitHub. While the version set up was already created in tandem to this document, RStudio will often require verification before you can push any committed changes to your code.

**This section is only needed for those modifying code**

```{r Git Setup, include = FALSE, message = FALSE, warning = FALSE}

# We will need the usethis package so that we can connect our GitHub

install.packages("usethis")
library(usethis)

# Using the usethis package we can tell R which user will be pushing new versions to the associated repository

use_git_config(user.name = "BLLoftin96", user.email = "brittanieloftin@u.boisestate.edu")

# This will show you who is logged in and will give you options following options: 1) Abort update with error, and keep the existing credentials, 2) Replace these credentials, and 3) See the password/token. If this is a fresh session, I would recommend the replace option and re-enter your current password/token to ensure there is no connection error. 

gitcreds::gitcreds_set()

# This will verify any changes

gitcreds::gitcreds_get()

```

# Background

The Cassia Crossbill (*Loxia sinesciuris*) is Idaho's only endemic species whose limited range and diet put the species at risk for extinction (*FIND CITATIONS FROM NWCASC ADVISOR GRANT RE: IDFWS AND CACR STATUS*; Parmesan 2006, Benkman 1993). Similar to other crossbills whose crossed mandibles aid in prying open the conifer cones of a single species (or a variety of species) to then forage on the seeds inside (Newton 1972, Benkman 1978a, Benkman 1978b, Benkman 1988a, Benkman 1988b, Benkman 1989, Benkman 1990, Benkman 1992, Benkman 1993, Benkman and Lindholm 1991). Cassia Crossbills feed almost exclusively on the serotinous cones of Rocky Mountain lodgepole pine (*Pinus contorta latifolia*) and are unable to survive competition with other crossbills for other seeds elsewhere (Benkman et al. 2001, Benkman et al. 2012, Benkman 2016). Unlike the far more common Red Crossbill (*Loxia curvirostra*) that are nomadic and able to travel vast distances for food, the Cassia Crossbill have a highly restricted range limited to the 67km2 of Rocky Mountain lodgepole pine forest found on two small mountain ranges in Idaho: the South Hills and the Albion Mountains (Benkman et al. 2009, Behl and Benkman 2018; Figure 1). Despite lodgepole pine existing in other areas, the Cassia Crossbill was able to evolve in this region due to the lack of red squirrels (*Tamiasciurus hudsonicus*) which typically preemptively out-compete crossbills for cones (Benkman 1999, Smith and Benkman 2007).

![Figure 1: Map showing the South Hills and Albion Mountain range. The white outline marks the boundary of the Sawtooth National Forest](C:/Users/britt/OneDrive/Pictures/CassiaSites1.png)

The combination of being a permanent resident restricted to high elevation environments and dependent on a singular resource makes the Cassia Crossbill extremely sensitive to habitat alteration or loss (Benkman 1993). For example, in 2020 the Badger Fire swept through the western portion of the South Hills and destroyed approximately 20% of the available lodgepole in the region. In subsequent years, annual trends in the population declines significantly (*FIND CITATION FROM NW CASC GRANTS OR ANNUAL REPORTS & FIGURES*). Wildfires in this region -like many other areas in the western US - are predicted to increase in frequency and intensity in the future (Brice et al. 2020, Rogers et al. 2020). Wildfires can damage or destroy the mature stands of lodgepole pine which contain the serotinous cones - cones sealed in a resin - that Cassia Crossbills forage on. However, when these areas experience stand-replacing fires the resin on the serotinous cones melts and seeds inside have the potential to germinate and create a new stand. Serotinous cones in this region may also be affected by high summer temperatures which some evidence has shown to cause these cones to open prematurely and allowing other species to access a once exclusive resource (Benkman et al. 2001, Benkman et al. 2012, Santisteban et al. 2012, Benkman 2016).

# Goals

# Data

LiDAR data was taken from [existing data from the Idaho LiDAR Consortium](https://www.idaholidar.org/existing-lidar-data/) and utilizing 5 different projects.

1.  Elko NW (2021 imagery) - South Hills - 196,727 ACRES
2.  Southern ID 2018 #12 - South Hills (**Note: Southern ID 2018 #12 is stored as Part 21 and Part 22**)
3.  Southern ID 2018 #14 - E. Albions
4.  Southern ID 2018 #15 - South Hills (**Note: Southern ID 2018 #15 is stored as 07_Cassia**)
5.  Southern ID 2018 #17 - E. South Hills and W. Albions (**Note: Southern ID 2018 #17 is stored as LAZ**)

## LiDAR Flight Information

### Elko NW

### Southern ID 2018 \# 12

### Southern ID 2018 \# 14

### Southern ID 2018 \# 15

### Southern ID 2018 \# 17

# Code

## Install Packages

```{r Install Packages}
# Install

install.packages('lidR')
install.packages('sf')
install.packages('lidRviewer', repos = c('https://r-lidar.r-universe.dev'))
install.packages('dplyr')
install.packages('terra')
install.packages('RCSF')

# Load
library(lidR)
library(sf)
library(lidRviewer)
library(dplyr)
library(terra)
library(RCSF)
```

## Data Inspection

Here I am selecting a few locations from each of the flight paths (e.g., Elko, South ID 201 #12, etc.) around my study area to visually inspect to see if the point cloud even reflects reality. To do this, I am using a package called lidRviewer that works in tandem with the lidR package to allow you to visualize the point cloud of selected tiles. The view acts by opening a new window that you can interface with - while open R cannot run other sections of code.

Commands:

-   Rotate with left mouse button

-   Zoom with mouse wheel

-   Pan with right mouse button

-   Keyboard r or g or b to color with RGB

-   Keyboard z to color with Z

-   Keyboard i to color with Intensity

-   Keyboard c to color with Classification

-   Keyboard + or - to change the point size

-   Keyboard l to enable/disable eyes-dome lightning

### Elko NW 2023

First tile, I will look at is one from the Elko NW that shows Father and Sons Campground in the South Hills (11TQG320710)

```{r Elko NW 2023 Viewer Inspection}
############### Father and Sons Camp (with logger) ################

# Load the Tile containing Father and Sons Campground
F_S_Camp = readLAS('R:/ElkoNW_LAZ/USGS_LPC_NV_NorthWestElko_2020_D20_11TQG320710.laz')

# Visually inspect
lidRviewer::view(F_S_Camp)  

################ Porcupine Springs (with loggers) ################

# Load the Tile 
F_S_Camp = readLAS('R:/ElkoNW_LAZ/USGS_LPC_NV_NorthWestElko_2020_D20_11TQG260710.laz')

# Visually inspect
lidRviewer::view(F_S_Camp)  

################ Logger MLPF-107 ################

# Load the Tile 
F_S_Camp = readLAS('R:/ElkoNW_LAZ/USGS_LPC_ID_SouthernID_2018_D19_11TQG350815.laz')

# Visually inspect
lidRviewer::view(F_S_Camp)  

################ Loggers LPO-034 and LPO-130 ################

# Load the Tile 
F_S_Camp = readLAS('R:/ElkoNW_LAZ/USGS_LPC_NV_NorthWestElko_2020_D20_11TQG305605.laz')

# Visually inspect
lidRviewer::view(F_S_Camp)  

```

I get a warning that there are 2343136 points that are withheld, so we will remove these. We also get a warning that 234136 are synthetic points so we will keep those.

*Note: reasoning for withholding 'withheld' points:*

-   *they are points the data provider recommends you ignore*

-   *overlap in flight lines*

-   *edge-of-scan artifacts*

-   *points kept for QA but not analysis*

-   *points excluded from the official product*

*I am keeping the synthetic points because:*

-   *adds improved surface continuity*

-   *points are generated during processing*

-   *densified surfaces in workflows*

Shows a lot of white points (unclassified points - white) so we will likely need to classify. I also saw one or two points that appeared to be an error - point above tree line.

### Southern ID 2018 # 12


```{r Southern ID 2018 # 12 Viewer Inspection}
################ Bear Gulch Campground ##############

# Load the Tile containing Bear Gulch Campground
B_G_Camp = readLAS('R:/Part22/USGS_LPC_ID_SouthernID_2018_D19_11TQG155770.laz')

# Visually inspect
lidRviewer::view(B_G_Camp)

################ Diamondfield Jack Campground ##############

# Load the Tile 
B_G_Camp = readLAS('R:/Part22/USGS_LPC_ID_SouthernID_2018_D19_11TQG230725.laz')

# Visually inspect

lidRviewer::view(B_G_Camp)

################ Unique (known) ##############

# Load the Tile 
B_G_Camp = readLAS('R:/Part21/Part21/USGS_LPC_ID_SouthernID_2018_D19_11TQG380725.laz')

# Visually inspect
lidRviewer::view(B_G_Camp)

################ Logger LPO-030 ##############

# Load the Tile 
B_G_Camp = readLAS('R:/Part22/USGS_LPC_ID_SouthernID_2018_D19_11TQG185710.laz')

# Visually inspect
lidRviewer::view(B_G_Camp)

```

I get a warning that there are 3720655 points that are withheld, so we will remove these. We also get a warning that 3720655 are synthetic points so we will keep those. I see lots of error points and unclassified points.

### Southern ID 2018 # 14

```{r Southern ID 2018 # 14 Viewer Inspection}

################# ref 1 #############

# Load the Tile 

T_F_Camp = readLAS('R:/SouthernIdaho2018_14_LAZ/SouthernIdaho2018_14_LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM820755.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)

################# ref 2 #############

# Load the Tile 

T_F_Camp = readLAS('R:/SouthernIdaho2018_14_LAZ/SouthernIdaho2018_14_LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM835740.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)

################# ref 3 #############

# Load the Tile 

T_F_Camp = readLAS('R:/SouthernIdaho2018_14_LAZ/SouthernIdaho2018_14_LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM850725.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)
```

### Southern ID 2018 # 15

```{r Southern ID 2018 # 15 Viewer Inspection}

################# ref 1 #############

# Load the Tile 

T_F_Camp = readLAS('R:/07_Cassia/USGS_LPC_ID_SouthernID_2018_D19_11TQG425815.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)

################# ref 2 #############

# Load the Tile 

T_F_Camp = readLAS('R:/07_Cassia/USGS_LPC_ID_SouthernID_2018_D19_11TQG440830.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)
```


### Southern ID 2018 # 17

```{r Southern ID 2018 # 17 Viewer Inspection}

############### Thompson Flat Campground ################

# Load the Tile 
T_F_Camp = readLAS('R:/LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM835890.laz')

# Visually inspect
lidRviewer::view(T_F_Camp)

############### Independence Lake Campground ###############

# Load Tile
T_F_Camp = readLAS('R:/LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM790770.laz')

# visually inspect
lidRviewer::view(T_F_Camp)

############### Logger LPO-060 #############
T_F_Camp = readLAS('R:/LAZ/USGS_LPC_ID_SouthernID_2018_D19_12TTM745695.laz')

# visually inspect
lidRviewer::view(T_F_Camp)
```

I get a warning that there are 318539 points that are withheld, so we will remove these. We also get a warning that 318539 are synthetic points so we will keep those. The worst one. So many error points - maybe there was smoke when they flew the plane.

Based on this information, we should reclassify these tiles. We should begin by working with these tiles to create a general pipeline for classification (which we can then use the **batch** function to do to all tiles).

## Classification Pipeline (3 Tiles)

Here our goal is to create a pipeline by generating code using these 3 tiles. We should then be able to batch these to other tiles in the study area. Process steps:

1.  Noise Filter - start with this in case there are unusual noise below ground (may accidentally create weird geometry and makes ground classification more stable)

2.  Classify Ground Points

3.  Second cleanup of noise - if needed

### Filter Noise

When looking at the datasets there are some obvious levels of noise (in fact the amount of noise increased with each tile we examined). Filtering out these extraneous high and low (below the scene) points will help to reduce error and get us closer to the actual landscape. Note: this is only using distance to neighboring points/returns and no use of scan angle/intensity

First let's try the **ivf (isolated voxel function)** from lidR to filter the noise by searching the returns for ones that are far away from neighbors.Let's try using a filter where we filter points that are no more than 12 returns within a resolution of 4m. We then filter the points by removing those that are classified as noise (the LASNOISE = 18).

Overall, we we should check if the IVF being too strict by either counting how many points were removed. Commonly, \< 1-2% is fine but anything greater than 5% should be looked at visually. We will also visually check the filters to see if they were appropriate and we may play with parameters to see which produces the best result.

Additionally, we will be filtering the withheld flagged points since they are not recommended for use.

```{r Filter Noise - IVF 4m & 12 returns}
# Father and Sons

# Filter Withheld
FSCamp_Filter <- filter_poi(F_S_Camp, !Withheld_flag) # Start: 31756788

# Filter  Noise
FSCamp_Filter <- classify_noise(FSCamp_Filter, ivf(res = 4, n = 12)) # classifies

unique(FSCamp_Filter@data[["Classification"]]) # shows the number of unique classifications: 1 (unclassified), 2 (ground), 3 (low vegetation), 4 (medium vegetation), 5 (high vegetation), 7 (low noise), and 18 (high noise). 

FSCamp_Filter = filter_poi(FSCamp_Filter, !Classification %in% c(7L, 18L)) # End: 31756299
 
lidRviewer::view(FSCamp_Filter) # visually inspect - looks pretty good with no obvious noise
lidRviewer::view(F_S_Camp)  # if you need to compare


# Bear Gulch
# Filter Withheld
BGCamp_Filter <- filter_poi(B_G_Camp, !Withheld_flag) # 48370837

# Classify all returns 
BGCamp_Filter <- classify_noise(BGCamp_Filter, ivf(res = 4, n = 12))

unique(BGCamp_Filter@data[["Classification"]]) # shows the number of unique classifications: 1 (unclassified), 2 (ground), 5 (high vegetation), 7 (low vegetation/low noise), and 18 (high noise). 
# in the code above we see that there are no 18 or 7 classified points so I doubt the filtering will do much

BGCamp_Filter = filter_poi(BGCamp_Filter, !Classification %in% c(7L, 18L)) # End with 48370837

lidRviewer::view(BGCamp_Filter) # visually inspect - looks pretty good with no obvious noise
lidRviewer::view(B_G_Camp) # if you need to compare


# Thompson Flat
# Filter Withheld
TFCamp_Filter <- filter_poi(T_F_Camp, !Withheld_flag) # start:

# Classify
TFCamp_Filter <- classify_noise(TFCamp_Filter, ivf(res = 4, n = 12)) # Start: 58022066

unique(TFCamp_Filter@data[["Classification"]]) # shows the number of unique classifications: 1 (unclassified), 2 (ground), 5 (high vegetation), 7 (low vegetation/low noise), and 18 (high noise). 

# Again no 7 or 18 class
TFCamp_Filter = filter_poi(TFCamp_Filter, !Classification %in% c(7L, 18L)) # End: 58022066

lidRviewer::view(TFCamp_Filter) # visually inspect - looks pretty good with no obvious noise
lidRviewer::view(T_F_Camp) # if you need to compare

```

### Ground Classification

Working in mountainous forests, we will need to keep track of the parameters that we use. It is standard to use a cloth simulation filter which is available through the LiDAR function csf(). With the csf function, the LiDAR point cloud is inverted, and a simulation of a “rigid cloth” is draped over the inverted point cloud. The simulated cloth surface is then used to determine which points are associated with the ground.

CSF is controlled by:

-   how stiff the 'cloth' is --\> rigidity

-   how coarse the 'cloth' mesh is --\> cloth resolution

-   much much sagging is allowed --\> slope smoothing

We will also be trying the PMF (progressive morphological filter) which creates a small window and fins the low points where it then gradually increases the window size and allow higher thresholds as terrain scale increases.Then, we will compare the two. I expect that the CSF may perform better compared to the PMF due to the mountainous terrain.

PMF is controlled by:

-   window size(s) (scale of terrain features)

-   height threshold (how much deviation from the ground is allowed)

**Here we will begin with starting with the default then check the DTM and tune from there. Since we are classifying these ourselves, we should be on the lookout for DTM pits, sinks, or 'wavy' terrain**

Once points are classified, you know which points are associated with the ground, but because points are not continuous on the ground, you still need to interpolate between them to get an elevation map. For this, you can use a Delaunay triangulation which interpolates a continuous surface as a triangulation between the points classified as ground. You can implement the triangulation using the rasterize_terrain() function in the lidR package with the tin() algorithm selected.

```{r}
# Example Code
Classified_las = classify_ground(ClassFilt_las, algorithm = csf())
Classified_Full_LAS <- classify_ground(Filt_Full_las, algorithm = csf())

# I get a warning saying points were originally classified. This is because NEON data - which is used for this - comes pre-classified; however, this is not always the case. 
lidRviewer::view(Classified_las)

lidRviewer::view(Classified_Full_LAS)

# Press c to view classified points. Blue = ground
DEM = rasterize_terrain(Classified_las, res = 1, algorithm = tin())
Full_DEM <- rasterize_terrain(Classified_Full_LAS, res = 1, algorithm = )

terra::plot(Full_DEM)
terra::plot(DEM)

# We can also make a map for slope and aspect
slope = terrain(DEM, v='slope', unit = 'degrees')
Full_slope <- terrain(Full_DEM, v ='slope', unit = 'degrees')
asp = terrain(DEM, v='aspect', unit = 'degrees')
Full_asp <- terrain(Full_DEM, v='aspect', unit = 'degrees')

par(mfrow=c(1, 2))
plot(slope)
plot(asp)
plot(Full_asp)
plot(Full_slope)
```

```{r Ground Classification}

# Father and Sons
##################################################### Cloth Simulation Filter ##########################################
# We will start with the default setting and we can make adjustments as we go
FSCamp_Grnd_CSF <- classify_ground(FSCamp_Filter, algorithm = csf())
lidRviewer::view(FSCamp_Grnd_CSF)
# Default setting appear pretty good, but it looks like it may be listing low vegetation 
lidRviewer::view(F_S_Camp)  # if you need to compare


# Bear Gulch


# Thompson Flat
```
